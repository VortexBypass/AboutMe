import crypto from'crypto';
const UPSTASH_URL=process.env.UPSTASH_REST_URL,UPSTASH_TOKEN=process.env.UPSTASH_REST_TOKEN;
async function u(path,body){return(await fetch(`${UPSTASH_URL}${path}`,{method:'POST',headers:{Authorization:`Bearer ${UPSTASH_TOKEN}`,'Content-Type':'application/json'},body:JSON.stringify(body)})).json()}
function h(x){return crypto.createHash('sha256').update(x).digest('hex')}
function ip(req){const x=req.headers['x-forwarded-for'];return x?x.split(',')[0].trim():(req.socket?.remoteAddress||'')}
export default async(req,res)=>{try{const op=new URL(req.url,'http://x').searchParams.get('op')||null;if(req.method==='GET'&&op==='get'){const r=await u('/get',{key:'afk:count'});return res.status(200).json({count:Number(r.result||0)})}const ipAddr=ip(req);if(!ipAddr){const g=await u('/get',{key:'afk:count'});return res.status(200).json({count:Number(g.result||0)})}const haship=h(ipAddr);const m=await u('/sismember',{key:'afk:ips',member:haship});if(m.result===1){const g=await u('/get',{key:'afk:count'});return res.status(200).json({count:Number(g.result||0)})}const multi=await u('/pipeline',{commands:[['sadd','afk:ips',haship],['incr','afk:count'],['get','afk:count']]});const val=Number(multi.result?.[2]||0);return res.status(200).json({count:val})}catch(e){return res.status(500).json({count:0})}}
